---
title: 'æ‚é¡¹çŸ¥è¯†'
date: 2022-9-10 15:30:00
permalink: '/posts/blogs/æ‚é¡¹çŸ¥è¯†'
isTimeLine: true
# sidebar: auto
# sidebarDepth: 1
category:
 - æˆ‘çš„å‰ç«¯è·¯çº¿
tag:
 - React
 - æ–‡ä»¶æ“ä½œ
 - javascript
 - css
# isShowComments: false
# publish: true
icon: pen-to-square
star: true
sticky: true
---


### æ–‡ä»¶ä¸‹è½½(iframeã€a)

```js
const getAwardStudentTemplate = () => {
    exportAwardStudentsList({}).then((res) => {
      if(res.data.Data !== null) {
        const a = document.createElement('a'); // aæ ‡ç­¾å¯¼å‡ºä¸‹è½½
        a.href = res.data.Data.DownloadUrl;
        a.click();
        a.remove();
      }
    })
    getImportFileTemplate({ params: { TabName: 'AwardA' } }).then((res) => {
      if (res.data.Data !== null) {
        let downloadUrl2 = res.data.Data.DownloadUrl;
        let iframe = document.createElement('iframe'); // iframeå¯¼å‡ºä¸‹è½½
        iframe.id = 'iframe2';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        iframe.src = downloadUrl2;
      }
    })
  }
```

#### è‡ªå®šä¹‰æ–‡ä»¶ä¸‹è½½å

* ç›´æ¥ä½¿ç”¨aæ ‡ç­¾ä¸‹è½½å¯èƒ½ä¼šå‡ºç°æ— æ³•è‡ªå®šä¹‰aæ ‡ç­¾ç›´æ¥ç»™downloadä¸ç”Ÿæ•ˆ

```js
const link = document.createElement('a')
const body = document.querySelector('body')

link.href = window.URL.createObjectURL(blob)
link.download = filename

// fix Firefox
link.style.display = 'none'
body?.appendChild(link)

link.click()
body?.removeChild(link)

window.URL.revokeObjectURL(link.href)
```

* å€Ÿç”¨XMLHttpRequestå°†urlè½¬æ¥æˆblobæµä¸‹è½½ï¼Œè‡ªå®šä¹‰æ–‡ä»¶å

```js
// 1. 
this.getBlob(res.data.Data.DownloadUrl).then((res) => {
  this.saveAs(res, 'è¯„å¥–è®°å½•åˆ—è¡¨.xlsx');
});

getBlob(url: string) {
  return new Promise((resolve, err) => {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'blob';
    xhr.onload = () => {
      if (xhr.status === 200) {
        resolve(xhr.response);
      }
    }
    xhr.send();
  })
}

saveAs(blob: any, filename: any) {
  const link = document.createElement('a')
  const body = document.querySelector('body')

  link.href = window.URL.createObjectURL(blob)
  link.download = filename

  // fix Firefox
  link.style.display = 'none'
  body?.appendChild(link)

  link.click()
  body?.removeChild(link)

  window.URL.revokeObjectURL(link.href)
}
  
// 2.ç›´æ¥è½¬blobåä¸‹è½½
const handleDownload = (url: string, filename: string) => {
  const x = new window.XMLHttpRequest();
  x.open('GET', url, true);
  x.responseType = 'blob';
  x.onload = () => {
    const url = window.URL.createObjectURL(x.response);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  };
  x.send();
}
```



### uploadæ–‡ä»¶accepté™åˆ¶

**ä¸Šä¼ ç»„ä»¶æ—¶ï¼Œä¸æ˜¯ç›´æ¥ä¸Šä¼ åç¼€åï¼Œè€Œæ˜¯æ–‡ä»¶åç¼€ï¼ˆæ‰©å±•åï¼‰å¯¹åº”æœ‰MIMEç±»å‹ï¼Œæ–¹ä¾¿iisä¸­æˆ–å…¶ä»–æœåŠ¡å™¨å¯¹ç›¸åº”çš„æ–‡ä»¶è¿›è¡Œè§£æã€‚æœ‰äº›æ–‡ä»¶çš„åç¼€åæ²¡æœ‰é»˜è®¤è§£æå°±å‡ºç°ä¸Šä¼ åæ— æ³•è®¿é—®æˆ–è€…ä¸‹è½½çš„é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦è®¾ç½®æ–‡ä»¶åç¼€å¯¹åº”çš„MIMEç±»å‹ï¼Œè®¾ç½®åæ‰èƒ½è®¿é—®æˆ–è€…ä¸‹è½½**

```
åç¼€å        ã€€ã€€MIMEåç§°
*.3gppã€€ã€€ ã€€ã€€ audio/3gpp, video/3gpp
*.ac3ã€€ã€€ã€€ã€€    audio/ac3
*.asf ã€€ã€€ã€€ã€€    allpication/vnd.ms-asf
*.au ã€€ã€€ã€€ã€€    audio/basic
*.css ã€€ã€€ã€€ã€€  text/css
*.csv  ã€€ã€€ã€€ã€€ text/csv
*.doc ã€€ã€€ã€€ã€€ application/msword
*.docx        application/vnd.openxmlformats-officedocument.wordprocessingml.document
*.dotã€€ã€€ã€€ã€€   application/msword
*.dtdã€€ã€€ã€€ã€€   application/xml-dtd
*.dwgã€€ã€€ã€€     image/vnd.dwg
*.dxfã€€ã€€ã€€ã€€   image/vnd.dxf
*.gifã€€ã€€ã€€ã€€    image/gif
*.htmã€€ã€€ã€€ã€€  text/html
*.htmlã€€ã€€ã€€ã€€ text/html
*.jp2                 image/jp2
*.jpe                 image/jpeg
*.jpeg               image/jpeg
*.jpg                 image/jpeg
*.js                   text/javascript, application/javascript
*.json               application/json
*.mp2               audio/mpeg, video/mpeg
*.mp3               audio/mpeg
*.mp4               audio/mp4, video/mp4
*.mpeg            video/mpeg
*.mpg              video/mpeg
*.mpp              application/vnd.ms-project
*.ogg              application/ogg, audio/ogg
*.pdf               application/pdf
*.png              image/png
*.pot               application/vnd.ms-powerpoint
*.pps              application/vnd.ms-powerpoint
*.ppt              application/vnd.ms-powerpoint
*.rtf                application/rtf, text/rtf
*.svf                image/vnd.svf
*.tif                  image/tiff
*.tiff                 image/tiff
*.txt                 text/plain
*.wdb              application/vnd.ms-works
*.wps              application/vnd.ms-works
*.xhtml            application/xhtml+xml
*.xlc                application/vnd.ms-excel
*.xlm               application/vnd.ms-excel
*.xls                application/vnd.ms-excel
*.xlt                 application/vnd.ms-excel
*.xlw               application/vnd.ms-excel
*.xml               text/xml, application/xml
*.zip                aplication/zip
*.xlsx              application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
```

### jsæ§åˆ¶æ–‡ä»¶ä¸Šä¼ é€‰æ‹©å™¨(æ³¨æ„æŸ¥çœ‹å…¼å®¹æ€§)

#### [showOpenFilePickeré€‰æ‹©æ–‡ä»¶](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/showOpenFilePicker)

```jsx
const importUserClick = async () => {
  try {
    const fileHandle = await (window as any).showOpenFilePicker({
      // é€‰æ‹©excelæ–‡ä»¶
      types: [{
        accept: {
          // 'image/*': ['.png', '.gif', '.jpeg', '.jpg', '.webp']
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
          'application/vnd.ms-excel': ['.xls']
        }
      }],
      multiple: false
    })
    // è·å–Fileå¯¹è±¡è½¬ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶æµ
    const file = await fileHandle[0].getFile()
    const arrayBuffer: any = await readFileAsArrayBuffer(file)
    const blob = new Blob([arrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    // åˆ›å»ºFormDataç»“æ„ä¼ ç»™åç«¯
    const formData = new FormData();
    formData.append('file', blob, 'upload.xlsx');
    await importUser(formData)
    // åç»­è¯·æ±‚ï¼Œæ›´æ–°æ•°æ®
    userTableForm?.current?.getTableData()
  } catch (error) {
    console.log(error)
  }
}
```

#### [showDirectoryPickeré€‰æ‹©æ–‡ä»¶å¤¹](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/showDirectoryPicker)

### æ–‡ä»¶ä¸Šä¼ å¯¼å…¥(form-dataçš„å½¢å¼æäº¤æ–‡ä»¶)æ–‡ä»¶ä¸Šä¼ ç»„ä»¶å€Ÿç”¨Upload

```js
const beforeUpload = async (file?: any) => {
  let formData = new FormData(); // åˆ›å»ºformData
  formData.append('File', file);
  formData.append('TabName', useLevel ? 'AwardB' : 'AwardA');
  formData.append('Term', TermYear);
  formData.append('Remark', AwardRecordID + '');
  axios({
    url: baseURL + '/Document/ImportData',
    method: 'post',
    data: formData,
    headers: {
      'Content-Type': 'multipart/form-data', // multipart/form-data
      'Authorization': `X-Token={${window.location.search.split('=')[1]}}`
    }
  }).then((res) => {
    console.log(res.data);
    if (res.data.Msg === 'success') {
      if (res.data.Data.url === '') {
        Message({
          message: 'æ–‡ä»¶å¯¼å…¥æˆåŠŸ',
          type: 'success',
          duration: 1500
        })
        getStudentsList(props.tableRowData.AwardRecordID);
        props.refreshAwardTable && props.refreshAwardTable();
      } else {
        const iframe = document.createElement('iframe');
        iframe.id = 'iframe2';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        iframe.src = res.data.Data.url;
        Message({
          message: 'æ–‡ä»¶å¯¼å…¥å¤±è´¥,å…·ä½“åŸå› è¯·æŸ¥çœ‹ä¸‹è½½æ–‡ä»¶',
          type: 'error',
          duration: 2000
        })
      }
    } else if (res.data.Msg === 'ç¨‹åºæ— æ³•è¯†åˆ«æ‚¨æ‰€ä½¿ç”¨çš„æ¨¡æ¿ï¼Œè¯·å°è¯•ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ¨¡æ¿') {
      useLevel ? (() => {
        Message({
          message: 'å¯¼å…¥æ–‡ä»¶æ¨¡æ¿é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„åŒºåˆ†ç­‰çº§æ¨¡æ¿',
          type: 'error',
          duration: 2300
        })
      })() : (() => {
        Message({
          message: 'å¯¼å…¥æ–‡ä»¶æ¨¡æ¿é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„éç­‰çº§æ¨¡æ¿',
          type: 'error',
          duration: 2300
        })
      })()
    }
  })
  return file;
}

<Upload // å€Ÿç”¨Uploadæ’ä»¶è°ƒç”¨æ–‡ä»¶ä¸Šä¼ 
  className="upload-demo"
  action='//jsonplaceholder.typicode.com/posts/'
  accept='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' // å‚è€ƒä¸Šæ¡
  beforeUpload={beforeUpload}
  listType='none'
>
  <LgButton
    className="lg_button_export"
    value={"å¯¼å…¥"}
    type="default"
    showIcon
    gradient
  />
</Upload>
```


### Dateè½¬string

```js
const date = new Date();
date.toISOString(); // å¤©æ•°ä¼šå°‘ä¸€å¤© ä¸è¡Œ
JSON.stringify(date);

// dateè½¬string
const dateToString = (date: any) => {
  var year = date.getFullYear();
  var month = (date.getMonth() + 1).toString();
  var day = (date.getDate()).toString();
  if (month.length == 1) {
    month = "0" + month;
  }
  if (day.length == 1) {
    day = "0" + day;
  }
  var hours = date.getHours().toString();
  if (hours.length == 1) {
    hours = "0" + hours;
  }
  var mintus = date.getMinutes().toString();
  if (mintus.length == 1) {
    mintus = "0" + mintus;
  }
  var second = date.getSeconds().toString();
  if (second.length == 1) {
    second = "0" + second;
  }
  var dateTime = year + "-" + month + "-" + day + " " + hours + ":" + mintus + ":" + second;
  return dateTime;
}
```

### åç«¯BlobäºŒè¿›åˆ¶æ–‡ä»¶é¢„è§ˆä¸ä¸‹è½½

* é¡¹ç›®ä¸­è¯·æ±‚å›¾ç‰‡æˆ–è€…ä¸‹è½½æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯**æ¥å£è¿”å›urlæˆ–è€…æ¥å£æœ¬èº«å°±æ˜¯ä¸€ä¸ªgetè¯·æ±‚è®¿é—®æ¥å£ç›´æ¥ä¸‹è½½**ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ**æ¥å£ä¼šè¿”å›ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æµ**ï¼Œåœ¨æ§åˆ¶å°æ‰“å°æˆ–è€…networkçš„previewä¸­å°±æ˜¯ä¸€ä¸²çœ‹ä¸æ‡‚çš„å­—ç¬¦ä¸²
* æ¥å£è¿”å›çš„æ–‡ä»¶çš„äºŒè¿›åˆ¶æµï¼Œé€šè¿‡jsçš„Blobå¯¹è±¡æ˜¯å¯ä»¥è½¬æˆæ–‡ä»¶ä¸‹è½½ä¸‹æ¥çš„

```ts
const fileType = getFileType(item.FileName.split('.')[item.FileName.split('.').length - 1]);
axios({
  url: `${mobxStore.ResHttpRootUrl}Download.ashx`,
  method: 'get',
  params: {
    FileUrl: item.FileUrl,
    FileName: item.FileName
  },
  headers: {
    'Authorization': `X-Token={${window.location.search.split('=')[1]}}`
  },
  responseType: 'blob'
}).then((res) => { // æ‹¿åˆ°blobæ•°æ®
  console.log(res);
  let blob = new Blob([res.data], { type: `${fileType};charset=utf-8` }); // æ ¹æ®ä¸åŒçš„æ–‡ä»¶ç±»å‹è½¬æ¢æˆä¸åŒçš„blob
  // blobäºŒè¿›åˆ¶æ–‡ä»¶é¢„è§ˆ
  let showFile = window.URL.createObjectURL(blob); // URL.createObjectURLå¯ä»¥å°†å°†blobèµ„æºè½¬æˆä¸€ä¸ªåœ°å€
  window.open(showFile); // è·³è½¬è‡³è¯¥åœ°å€å³ä¸ºé¢„è§ˆ
  // blobäºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½
  if ((navigator as any).msSaveBlob) {  // å¦‚æœæµè§ˆå™¨å…·å¤‡
    console.log('13214214');
    (navigator as any).msSaveBlob(blob);
  } else {
    const a = document.createElement('a');
    a.href = showFile;
    a.download = item.FileName;
    a.click(); // é€šè¿‡aé“¾æ¥ç‚¹å‡»çš„æ–¹å¼å³ä¸ºä¸‹è½½
    URL.revokeObjectURL(a.href);
    a.remove();
  }
})

const getFileType = (type: string) => {
  switch (type) {
    case 'pdf':
      return 'application/pdf'
    case 'jpeg':
      return 'image/jpeg'
    case 'jpg':
      return 'image/jpeg'
    case 'png':
      return 'image/png'
    case 'gif':
        return 'image/gif'
    case 'doc':
      return 'application/msword'
    case 'docx':
      return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    default:
      return 'text/plain'
  }
}
```

### Blobæ–‡ä»¶æµè·å–ï¼Œæ–‡ä»¶æµè½¬Fileä¸Šä¼ (åŒ<Upload />ç»„ä»¶)ï¼Œè·å–æ–‡ä»¶é“¾æ¥

```jsx
  const downloadWaterMarkFile = async (data: any) => {
    try {
      const res: any = await request({
        url: 'escis/api/file/download',
        method: 'get',
        params: { fileName: fileName },
        responseType: 'blob'
      });
      console.log('%c Line:39 ğŸŒ½ res', 'color:#ea7e5c', res, res instanceof Blob);
    } catch (error) {
      // console.log('%c Line:60 ğŸ¥” error', 'color:#42b983', error);
      // Toast.show({ content: `${error}`, duration: 3000 });
      if (error instanceof Blob) {
        // 1.æ–‡ä»¶æµè·å–
        const blob = new Blob([error], {
          type: 'application/octet-stream'
        });
        const fileName = `éšæ‚£æŠ¥é€_${dayjs().format('YYYYMMDDHHmmss')}.docx`;
        
        // 2.æ–‡ä»¶æµBlobè½¬Fileè¿›è¡Œä¸Šä¼ ï¼Œè·å–æ–‡ä»¶é“¾æ¥
        const file = new File([blob], fileName, { type: blob.type });
        const formData = new FormData();
        formData.append('file', file, fileName);
        try {
          const res: any = await request({
            url: 'escis/api/file/emergency/uploadAttachment',
            method: 'post',
            data: formData
            // responseType: 'blob'
          });
          const filePath = Decrypt(res.data).split('"').join('')
          const path = `${window.location.origin}/file/escis/${filePath}`
          console.log('%c Line:86 ğŸ‘ resï¼Œæ–‡ä»¶åç¼€', 'color:#93c0a4', res, filePath, 'è¯·æ±‚', path);
          Toast.show({ content: `resï¼Œæ–‡ä»¶åç¼€${path}`, duration: 3000 });

          // 3.å‘é€actionè·å–é“¾æ¥è§¦å‘æ‰‹æœºä¸‹è½½
          const action = {
            actionType: 'download_action',
            extra: {
              path: path,
              // fileNameæ€»é•¿åº¦ä¸èƒ½è¶…è¿‡82å¦åˆ™appä¸‹è½½æ–‡ä»¶ä¼šå‡ºé”™ fileName90+ _xxxå››ä½æ—¶é—´æˆ³ + .docxäº”ä½åç¼€å
              fileName: (fileName).slice(0, 80) + '_' + (new Date().getTime() + '').slice(-3) + (fileName.indexOf('.doc') ? filePath.slice(filePath.indexOf('.doc')) : '.docx')
            }
          };
          window.postMessage(JSON.stringify(action));
        } catch (err: any) {
        }
      }
    }
  }
```

### window.location.hrefå’Œwindow.open

**window.location.hrefé€‚ç”¨äºæ”¹å˜å½“å‰é¡µé¢çš„åœ°å€è·¯å¾„**

**window.opené€‚ç”¨äºä¿ç•™å½“å‰é¡µé¢ï¼Œæ–°å¼€ä¸€ä¸ªtabé¡µ(ä¸é€‚åˆç”¨äºåœ¨appå†…åµŒå¥—çš„h5å†…ä½¿ç”¨)**

è°¨è®°ï¼ï¼ï¼

### [Blobæ–‡ä»¶æµä¸‹è½½ typeç±»å‹](https://blog.csdn.net/weixin_43550766/article/details/121991772)

#### acceptç±»å‹é™åˆ¶ç›´æ¥ä½¿ç”¨'.jpg,.jpeg,.png'ä¹Ÿå¯!!!

```js
let url = window.URL.createObjectURL(new Blob([æ–‡ä»¶æµ(ä¸€èˆ¬ä¸ºres.data)], { type: 'Blobç±»å‹' }))
let link = document.creatElement('a') // åˆ›å»ºaæ ‡ç­¾æ¥ä¸‹è½½
link.style.display = 'none'
link.href = url
link.setAttribute('download', 'ä¸‹è½½çš„æ–‡ä»¶å')
document.body.appendChild(link)
link.click()
document.body.removeChild(link)

æ³¨ï¼šåœ¨requestè¯·æ±‚ä¸­éœ€åŠ responseType: 'Blob'
åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/weixin_43550766/article/details/121991772
```

### æ‰¹é‡å¤„ç†åç«¯è¿”å›çš„imgå›¾ç‰‡(blobæ ¼å¼çš„æ–‡ä»¶æµ)ï¼Œå¹¶è½¬æˆurlå±•ç¤ºã€å¤šé‡å¼‚æ­¥å¤„ç†Promise.all![vi4KtU.png](https://s1.ax1x.com/2022/07/30/vi4KtU.png)

```js
getConsultantDetail({ // è¯·æ±‚æ•°æ®
  ConsultantID: consultantItemInfo.consultant_id
}).then(async (res) => {
  if(res.data.Data !== null && res.data.Data.Files) {
    console.log(`æœ‰${res.data.Data.Files.length}å¼ å›¾ç‰‡`);
    // mapé‡ŒåŒ…å«å¼‚æ­¥æ“ä½œçš„å¤„ç†
    // ä½¿ç”¨Promnise.allåŒ…è£¹mapè¿”å›çš„å¤šä¸ªpromiseï¼Œæ³¨æ„async ä¸ awaitçš„ä½¿ç”¨ç”¨æ³•
    let urls = await Promise.all(res.data.Data.Files.map(async (item: any, index: number) => { 
      return await downloadData(item);
    }))
    setImgUrlList([...urls]);
  } else {
    console.log('æ²¡æœ‰å›¾ç‰‡');
    setImgUrlList([]);
  }
})
// 
const downloadData = async (item: any): Promise<string> => {
    // console.log(res);
    // æ ¹æ®ä¸åŒçš„æ–‡ä»¶ç±»å‹è¿›è¡Œè½¬ç ->blob
    let blob = new Blob([item], { type: `${fileType};charset=utf-8` }); // æ ¹æ®ä¸åŒçš„æ–‡ä»¶ç±»å‹è½¬æ¢æˆä¸åŒçš„blob
    let url = window.URL.createObjectURL(blob); // è½¬æˆurl
    urlStr = url;
}
```

### imgå’Œbackground-image(uriçš„ç¼–è§£ç decodeURIComponent)

* **decodeURI** åªèƒ½è§£ç  encodeURI å¤„ç†çš„å­—ç¬¦ä¸²ï¼Œå¤šç”¨äºå¤„ç†ç›¸å¯¹è·¯å¾„æ–‡ä»¶çš„ä¼ é€’
* **decodeURIComponent** å¯ä»¥å¤„ç† encodeURIComponent å’Œ encodeURI å¤„ç†çš„å­—ç¬¦ä¸²ï¼Œå¤šç”¨äºå¤„ç†urlå›¾ç‰‡è·¯å¾„è¿™äº›

```css
<img src='./image/test.jpg' alt='å›¾ç‰‡åŠ è½½å¤±è´¥' />
<img src='https://s1.ax1x.com/2022/07/30/vi4KtU.png' alt='å›¾ç‰‡åŠ è½½å¤±è´¥' />

background-image: url('./image/test/jpg');
background-image: url(decodeURIComponent('https://s1.ax1x.com/2022/07/30/vi4KtU.png'));
```

### iframeé€šä¿¡ç›¸å…³(iframe.postMessageè·¨åŸŸé€šä¿¡ä¸windowçš„messageæ¶ˆæ¯æ•è·)

* #### iframe.contentWindow.postMessage

* `postMessage`æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥è®¾ç½®è¦å‘é€åˆ°å“ªä¸ªurlï¼Œå¦‚æœå½“å‰å­é¡µé¢çš„urlå’Œè®¾ç½®çš„ä¸ä¸€è‡´ï¼Œåˆ™ä¼šå‘é€å¤±è´¥ï¼Œæˆ‘ä»¬è®¾ç½®ä¸º`*`ï¼Œä»£è¡¨æ‰€æœ‰urléƒ½å…è®¸å‘é€ã€‚

* `postMessage`æ–¹æ³•è¿˜æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå±äºé«˜çº§ç”¨æ³•ï¼Œè¿™é‡Œä¸åšè®¨è®ºï¼Œå¯ä»¥ç¨åå»[MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)äº†è§£ã€‚

```js
// åˆ¤æ–­æ˜¯å¦æ˜¯iframe
const isIFrame = (input: HTMLElement | null): input is HTMLIFrameElement =>
input !== null && input.tagName === 'IFRAME';

const iframe = document.createElement('iframe');
iframe.id = 'test_iframe_message';

let addExamIframe = document.getElementById('test_iframe_message');
// react+tsä¸­å¯èƒ½ä¼šæŠ¥é”™iframeä¸Šä¸å­˜åœ¨contentWindowå±æ€§ï¼Œè¦å…ˆé€šè¿‡isIFrameå‡½æ•°åˆ¤æ–­è¯¥iframeå±äºHTMLIFrameElementå…ƒç´ ï¼Œ
// å†é€šè¿‡postMessageå°†æ•°æ®å‘é€å‡ºå»ï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨
addExamIframe && isIFrame(addExamIframe) && addExamIframe.contentWindow?.postMessage(JSON.stringify(addExamObj), '*');
```

* #### window.addEventListener('message', handler)æ•è·iframeäº‹ä»¶

```jsx
useEffect(() => {
  window.addEventListener('message', messageHandler);
}, [window])

useEffect(() => {
  return () => {
    // ç§»é™¤windowçš„messageç›‘å¬
    window.removeEventListener('message', messageHandler);
  }
}, [])

// è·å–iframeè¿”å›çš„æ•°æ®å›è°ƒï¼Œmessageçš„ç›‘å¬ä¼šè¿›åˆ°è®¸å¤šå…¶ä»–æ¥è‡ªwindowçš„æ¶ˆæ¯ï¼Œæ³¨æ„åŒºåˆ†å³å¯
const messageHandler = (data: any) => {
  console.log(data);
}
```

* #### iframeå‘çˆ¶çº§é¡µé¢ä¼ é€’ä¿¡æ¯é€šä¿¡

```ts
const btnClick = () => {
  window.parent.postMessage(messageToParent, '*'); // æ³¨æ„ï¼š'*' è¡¨ç¤ºä¸é™åˆ¶æ¥æ”¶æ¶ˆæ¯çš„æºï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä½ åº”è¯¥æŒ‡å®šç¡®åˆ‡çš„æºã€‚
}

// çˆ¶çº§é¡µé¢
useEffect(() => {
  window.addEventListener('message', messageListener);
  return () => {
    window.removeEventListener('message', messageListener);
  }
}, []);

const messageListener = (event) => {
  console.log('æ¥æ”¶åˆ°iframeä¼ é€’è¿‡æ¥çš„ä¿¡æ¯', event)
}
```

* #### å…¶ä»–æ›´è¯¦ç»†iframeé€šä¿¡è¯·å‚è€ƒ[iframe](https://blog.csdn.net/bslydhs/article/details/123473390)

### å¸¸ç”¨ä½¿ç”¨çš„å·¥å…·æ–¹æ³•(utilFunctions)

```ts
import { useEffect, useRef, useState } from "react";

const moment = require('moment');

export function formatDataSize(size: number) {
  if(size >= 1073741824) {
    let integer = size / 1024;
    return integer.toFixed(1) + 'G';
  } else if (size >= 1048576) {
    let integer = size / 1024;
    return integer.toFixed(1) + 'M';
  } else {
    let integer = size / 1024;
    return integer.toFixed(1) + 'K';
  }
}

// é˜¿æ‹‰ä¼¯è½¬ä¸€äºŒä¸‰
export function toChinesNum(num: any) {
  let changeNum = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹']
  let unit = ['', 'å', 'ç™¾', 'åƒ', 'ä¸‡']
  num = parseInt(num)
  let getWan = (temp: any) => {
    let strArr = temp.toString().split('').reverse()
    let newNum = ''
    let newArr: any = []
    strArr.forEach((item: any, index: number) => {
      newArr.unshift(item === '0' ? changeNum[item] : changeNum[item] + unit[index])
    })
    let numArr: any = []
    newArr.forEach((m: any, n: any) => {
      if (m !== 'é›¶') numArr.push(n)
    })
    if (newArr.length > 1) {
      newArr.forEach((m: any, n: any) => {
        if (newArr[newArr.length - 1] === 'é›¶') {
          if (n <= numArr[numArr.length - 1]) {
            newNum += m
          }
        } else {
          newNum += m
        }
      })
    } else {
      newNum = newArr[0]
    }
    return newNum
  }
  let overWan = Math.floor(num / 10000)
  let noWan: any = num % 10000
  if (noWan.toString().length < 4) {
    noWan = '0' + noWan
  }
  return overWan ? getWan(overWan) + 'ä¸‡' + getWan(noWan) : (getWan(num).slice(0, 2) === 'ä¸€å'? getWan(num).slice(1): getWan(num));
}

// Dateè½¬string
export function dateToString (date: any) {
  var year = date.getFullYear();
  var month = (date.getMonth() + 1).toString();
  var day = (date.getDate()).toString();
  if (month.length == 1) {
    month = "0" + month;
  }
  if (day.length == 1) {
    day = "0" + day;
  }
  var hours = date.getHours().toString();
  if (hours.length == 1) {
    hours = "0" + hours;
  }
  var mintus = date.getMinutes().toString();
  if (mintus.length == 1) {
    mintus = "0" + mintus;
  }
  var second = date.getSeconds().toString();
  if (second.length == 1) {
    second = "0" + second;
  }
  var dateTime = year + "-" + month + "-" + day + " " + hours + ":" + mintus + ":" + second;
  return dateTime;
}

// è·å–æœ€è¿‘å››ä¸ªå­¦å¹´
export function getRecentYearOptions() {
  let [ currentYear, currentMonth ] = moment().format('YYYY-MM').split('-');
  if(currentMonth[0] === '0') currentMonth = currentMonth[1];
  const yearOptions = []
  if(parseInt(currentMonth) < 9) {
    for(let i = 0; i < 4; i++) {
      yearOptions.push({
        value: `${parseInt(currentYear)-i-1}-${parseInt(currentYear)-i}`,
        label: `${parseInt(currentYear)-i-1}-${parseInt(currentYear)-i}å­¦å¹´`
      })
    }
  } else {
    for(let i = 0; i < 4; i++) {
      yearOptions.push({
        value: `${parseInt(currentYear)-i}-${parseInt(currentYear)-i+1}`,
        label: `${parseInt(currentYear)-i}-${parseInt(currentYear)-i+1}å­¦å¹´`
      })
    }
  }
  return yearOptions;
}

// åŠ¨æ€è·å–çª—å£å®½é«˜
interface WindowSize {
  width: number,
  height: number
}

export const useWindowSize = (): WindowSize => {
  const [windowSize, setWindowSize] = useState<WindowSize>({
    width: 0,
    height: 0
  })

  useEffect(() => {
    const handler = () => {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight
      })
    }

    window.addEventListener('resize', handler);
    return () => {
      window.removeEventListener('resize', handler);
    }
  }, [])

  return windowSize;
}

// è·å–setDataå›è°ƒçš„æœ€æ–°å€¼
export const useSyncState: any = (state: any) => {
  const cbRef: { current: any } = useRef();
  const [data, setData] = useState(state);

  useEffect(() => {
    cbRef.current && cbRef.current(data);
  }, [data]);

  return [
    data,
    (val: any, callback: any) => {
      cbRef.current = callback;
      setData(val);
    },
  ];
};

// è·å–urlçš„å„ä¸ªå‚æ•°ï¼šåè®®ã€ä¸»æœºã€ç«¯å£ã€è·¯å¾„
//è§£æURL
export function parseUrl(str:any):any{//JSæ­£åˆ™è¡¨è¾¾å¼è§£æURL(åè®®/åŸŸå/ç«¯å£/è·¯å¾„/å‚æ•°/é”šç‚¹)
   const options = {
      key: ["source", "protocol", "authority", "userInfo", "user", "password", "host", "port", "relative", "path", "directory", "file", "query", "anchor"],
      q: {
         name: "queryKey",
         parser: /(?:^|&)([^&=]*)=?([^&]*)/g
      },
      parser: {
         loose: /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/
      }
   }

   if (!str) {
      return '';
   }

   let m = options.parser.loose.exec(str) as any
   let uri = {}
   let i = 14

   while (i--) uri[options.key[i]] = m[i] || "";

   uri[options.q.name] = {};
   uri[options.key[12]].replace(options.q.parser, function (_:string, $1:string, $2:string) {
      if ($1) uri[options.q.name][$1] = $2;
   });

   return uri;
}
```

### myEventå…¨å±€äº‹ä»¶æ€»çº¿

```js
class Event {
    events
    constructor() {
      this.events = {};
    }
   
    // ç›‘å¬
    on(eventName, callBack) {
      if (this.events[eventName]) {
        // å­˜åœ¨äº‹ä»¶
        this.events[eventName].push(callBack);
      } else {
        // ä¸å­˜åœ¨äº‹ä»¶
        this.events[eventName] = [callBack];
      }
    }
   
    // è§¦å‘
    emit(eventName, params) {
      if (this.events[eventName]) {
        this.events[eventName].map((callBack) => {
          callBack && callBack(params);
        })
      }
    }

    // ç§»é™¤
    remove(eventName, callBack) {
      let _index = -1;
      if(this.events[eventName]) {
        this.events[eventName].forEach((item, index) => {
          if(item == callBack) {
            _index = index; 
          }
        })
      }
      this.events[eventName].splice(_index, 1);
    }
  }
 const myEvent = new Event()
  export default myEvent;
```



### åŠ¨æ€ä¿®æ”¹é¡µé¢æ ‡é¢˜å’Œicon

#### querySelectorä¸getElementBy

* å¸¸è§çš„è·å–å…ƒç´ çš„æ–¹æ³•æœ‰3ç§ï¼Œåˆ†åˆ«æ˜¯é€šè¿‡å…ƒç´ IDã€é€šè¿‡æ ‡ç­¾åå­—å’Œé€šè¿‡ç±»åå­—æ¥è·å–
  * document.getElementById('idName'); document.getElementsByTagName(tagName); document.getElementsByClassName('className');
* **querySelector()** æ–¹æ³•è¿”å›**åŒ¹é…æŒ‡å®š CSS é€‰æ‹©å™¨å…ƒç´ çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ** ã€‚ è¯¥æ–¹æ³•åªè¿”å›åŒ¹é…æŒ‡å®šé€‰æ‹©å™¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœè¦è¿”å›æ‰€æœ‰åŒ¹é…å…ƒç´ ï¼Œéœ€è¦ä½¿ç”¨ **querySelectorAll()** æ–¹æ³•æ›¿ä»£ï¼
* åŒºåˆ«ï¼š**getElementByæ˜¯åŠ¨æ€çš„ï¼Œå½“å…ƒç´ çš„å†…å®¹æ”¹å˜äº†ï¼Œè·å–çš„å…ƒç´ èŠ‚ç‚¹å†…å®¹ä¹Ÿéšä¹‹æ”¹å˜**ã€‚
* querySelectoræ˜¯ä¸å˜çš„ã€‚

```ts
// åŠ¨æ€ä¿®æ”¹å›¾æ ‡
let titleIcon: any = document.querySelector('link[rel="icon"]');
if(titleIcon !== null) { titleIcon.href = decodeURIComponent(require('./images/123333.png')); }
// åŠ¨æ€ä¿®æ”¹æµè§ˆå™¨title
// console.log(document.getElementsByTagName('title')[0]);
// let title: any = document.getElementsByTagName('title')[0];
// title.innerHTML = 'å¿ƒç†å’¨è¯¢é¢„çº¦'; 
// æˆ–ä¸‹é¢çš„æ–¹æ³•
let title = document.querySelector('title');
if(title !== null) { title.innerHTML = 'æ–°æ ‡é¢˜'; }
```

### divå¯Œæ–‡æœ¬æ˜¾ç¤º

```js
<div dangerouslySetInnerHTML={{ __html: this.state.psychologyInformationItem.content }} className='lg_rich_text_show'></div>
```

### TypeScripté’ˆå¯¹å…ƒç´ (Element)çš„ç±»å‹

### (åŸç”Ÿjs)è‡ªå®šä¹‰äº‹ä»¶çš„è§¦å‘

```js
// åˆ›å»ºäº‹ä»¶
var event = document.createEvent("HTMLEvents");
// å®šä¹‰äº‹ä»¶å
event.initEvent("aaa", true, true); // 3ä¸ªå‚æ•°ï¼šäº‹ä»¶ç±»å‹ï¼Œæ˜¯å¦å†’æ³¡ï¼Œæ˜¯å¦é˜»æ­¢æµè§ˆå™¨çš„é»˜è®¤è¡Œä¸º
// è§¦å‘äº‹ä»¶
window.dispatchEvent(event);

// é€šè¿‡äº‹ä»¶åç›‘å¬äº‹ä»¶çš„è§¦å‘
window.addEventListener('aaa', function(event) {
  console.log(event.name, event.message);
}, false); // ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºfalseè¡¨ç¤ºè¯¥å…ƒç´ åœ¨äº‹ä»¶çš„â€œå†’æ³¡é˜¶æ®µâ€ï¼ˆç”±å†…å‘å¤–ä¼ é€’æ—¶ï¼‰å“åº”äº‹ä»¶ã€‚
```

### reactä¸­å„ç»„ä»¶cssä½œç”¨åŸŸè§£å†³æ–¹æ¡ˆ(data-component) æœ€ä¼˜æ–¹æ¡ˆ(é”™è¯¯)!!

```jsx
function App() {
  return (
    <div className="app" data-component="app">
      <div className="content">
      </div>
    </div>
  );
}
```

```scss
[data-component=app] {
  .content {
    
  }
}
```

### iframeé€šä¿¡

* çˆ¶é¡µé¢å‘é€æ¶ˆæ¯

```jsx
let addExamIframe = document.getElementById('lg_add_psychology_exam');
    addExamIframe && isIFrame(addExamIframe) && addExamIframe.contentWindow?.postMessage(JSON.stringify(addExamObj), '*');
```

### websocket

* websocketæ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œæ˜¯HTML5å¼€å§‹æä¾›çš„**åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®**ï¼Œè¿™ä¸ªå¯¹æ¯”ç€HTTPåè®®æ¥è¯´ï¼ŒHTTPåè®®æ˜¯ä¸€ç§æ— çŠ¶æ€çš„ã€æ— è¿æ¥çš„ã€å•å‘çš„åº”ç”¨å±‚åè®®ï¼Œé€šä¿¡è¯·æ±‚åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ï¼ŒæœåŠ¡ç«¯å¯¹è¯·æ±‚åšå‡ºåº”ç­”å¤„ç†ï¼›
* **HTTPåè®®æ— æ³•å®ç°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘èµ·æ¶ˆæ¯**ï¼Œwebsocketè¿æ¥**å…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´**è¿›è¡Œ**å…¨åŒå·¥é€šä¿¡**ï¼Œä»¥ä¾¿ä»»ä¸€æ–¹éƒ½å¯ä»¥é€šè¿‡å»ºç«‹çš„è¿æ¥å°†æ•°æ®æ¨é€åˆ°å¦ä¸€ç«¯ã€‚websocketåªéœ€è¦å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œå°±å¯ä»¥ä¸€ç›´ä¿æŒè¿æ¥çŠ¶æ€ï¼›
* WebSocketä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œ**å…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®**ã€‚åœ¨**WebSocket APIä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹**ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥**åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥**ï¼Œå¹¶è¿›è¡Œ**åŒå‘æ•°æ®ä¼ è¾“**ã€‚

```javascript
// åˆ›å»ºwebsocketè¿æ¥
const socket = new WebSocket('ws://localhost:3000');

// è¿æ¥æˆåŠŸè§¦å‘
socket.addEventListener('open', function(event) {
  socket.send('Hello server');
});

// ç›‘å¬æ¶ˆæ¯
socket.addEventListener('message', function(event) {
  console.log('message from server', event.data);
});
```

### æ·˜å®é•œåƒã€cnpm

* `npm config get registry`ï¼ŒæŸ¥çœ‹å½“å‰é•œåƒä½¿ç”¨çš„åœ°å€ï¼Œè¿”å›æˆåŠŸï¼Œåˆ™ä»£è¡¨è®¾ç½®æˆåŠŸ
* `npm config set registry https://registry.npm.taobao.org`ï¼Œåˆ‡æ¢å›½å†…é•œåƒï¼Œä½¿ç”¨æ·˜å®é•œåƒ

#### cnpm

* `npm install -g cnpm --registry=https://registry.npmmirror.com`

### æ™®é€šæ—¶é—´å­—ç¬¦ä¸²è½¬æ—¶é—´æˆ³

#### '2022-12-16 16:54:42' è½¬æˆæ—¶é—´æˆ³ï¼š

```jsx
new Date('2022-12-16 16:54:42').getTime(); // 1671180882000

Date.parse('2022-12-16 16:54:42'); // 1671180882000
```

### æ—¶é—´æˆ³è½¬'åˆšåˆš'ã€'1åˆ†é’Ÿå‰'ã€'1å°æ—¶å‰'

```jsx
formatTimeStamp(1671180882000);
export function formatTimeStamp(timespan) {
  console.log(timespan);
  //timespanæ˜¯ä¸€ä¸ªæ—¶é—´æ¯«ç§’ï¼Œæ³¨æ„æ—¶é—´æˆ³æ˜¯ç§’çš„å½¢å¼ï¼Œåœ¨è¿™ä¸ªæ¯«ç§’çš„åŸºç¡€ä¸Šé™¤ä»¥1000ï¼Œå°±æ˜¯åä½æ•°çš„æ—¶é—´æˆ³ã€‚13ä½æ•°çš„éƒ½æ˜¯æ—¶é—´æ¯«ç§’ã€‚
  var dateTime = new Date(timespan) // å°†ä¼ è¿›æ¥çš„å­—ç¬¦ä¸²æˆ–è€…æ¯«ç§’è½¬ä¸ºæ ‡å‡†æ—¶é—´
  var year = dateTime.getFullYear()
  var month = dateTime.getMonth() + 1
  var day = dateTime.getDate()
  var hour = dateTime.getHours()
  var minute = dateTime.getMinutes()
  var second = dateTime.getSeconds()
  // var second = dateTime.getSeconds()
  var millisecond = dateTime.getTime() // å°†å½“å‰ç¼–è¾‘çš„æ—¶é—´è½¬æ¢ä¸ºæ¯«ç§’
  var now = new Date() // è·å–æœ¬æœºå½“å‰çš„æ—¶é—´
  var nowNew = now.getTime() // å°†æœ¬æœºçš„æ—¶é—´è½¬æ¢ä¸ºæ¯«ç§’
  var milliseconds = 0
  var timeSpanStr
  milliseconds = nowNew - millisecond
  if (milliseconds <= 1000 * 60 * 1) { // å°äºä¸€åˆ†é’Ÿå±•ç¤ºä¸ºåˆšåˆš
    timeSpanStr = 'åˆšåˆš'
  } else if (1000 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60) { // å¤§äºä¸€åˆ†é’Ÿå°äºä¸€å°æ—¶å±•ç¤ºä¸ºåˆ†é’Ÿ
    timeSpanStr = Math.round((milliseconds / (1000 * 60))) + 'åˆ†é’Ÿå‰'
  } else if (1000 * 60 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24) { // å¤§äºä¸€å°æ—¶å°äºä¸€å¤©å±•ç¤ºä¸ºå°æ—¶
    timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60)) + 'å°æ—¶å‰'
  } else if (1000 * 60 * 60 * 24 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24 * 15) { // å¤§äºä¸€å¤©å°äºåäº”å¤©å±•ç¤ºä½å¤©
    timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60 * 24)) + 'å¤©å‰'
  } else if (milliseconds > 1000 * 60 * 60 * 24 * 15 && year === now.getFullYear()) {
    timeSpanStr = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second
  } else {
    timeSpanStr = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second
  }
  return timeSpanStr
}
```

### æ•°ç»„æ–¹æ³•

#### ä¼šæ”¹å˜åŸæ•°ç»„çš„

```ts
arr.push('aaa')
arr.pop()
arr.shift()
arr.unshift('bbb')
arr.sort()
arr.reverse()
arr.splice(0, 1, 'ccc')
```

#### ä¸ä¼šæ”¹å˜åŸæ•°ç»„çš„

```ts
arr.split() // è¿”å›ç¬¦åˆæ¡ä»¶çš„æ•°ç»„
arr.concat() // è¿”å›è¿æ¥åçš„æ•°ç»„
arr.slice() // è¿”å›åˆ‡å‰²åçš„æ–°æ•°ç»„
arr.forEach() // éå†æ•°ç»„
arr.map() // è¿”å›æ“ä½œè¿‡itemçš„æ•°ç»„
arr.some() // åˆ¤æ–­itemç¬¦åˆæ¡ä»¶å¦ï¼Œè¿”å›Boolean
```

### [æµè§ˆå™¨è·å–ç”¨æˆ·åœ°ç†ä½ç½®(geolocation)](https://www.w3.org/TR/geolocation/#introduction)

å¯ä»¥é€šè¿‡è·å–åˆ°çš„ç»åº¦(longitude)ã€çº¬åº¦(latitude)ï¼Œé€šè¿‡åç«¯æœåŠ¡å™¨æˆ–è€…è°ƒç”¨ç™¾åº¦ã€é«˜å¾·çš„sdk(software develop kit)è·å–ä½ç½®
chromeæµè§ˆå™¨ä¸­éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½è·å–åˆ°ç»çº¬åº¦ï¼ˆä»chromeä¸­è·å–ä½ç½®ä¿¡æ¯ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä½¿ç”¨ç”µè„‘ä¿å­˜çš„åœ°å€æ‹¿åˆ°ç”µè„‘ipåœ°å€ï¼ŒæŠŠipåœ°å€å‘åˆ°googleæœåŠ¡å™¨ï¼‰ï¼Œedgeæµè§ˆå™¨ä¸­ï¼ˆä»edgeä¸­è·å–ä½ç½®ä¿¡æ¯ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä½¿ç”¨ç”µè„‘ä¿å­˜çš„åœ°å€ï¼‰

```js
function positionClick() {
  console.log('positionç‚¹å‡»')
  navigator.geolocation.getCurrentPosition(res => {
    console.log(res)
  }, err => {
    console.log(err)
  }, {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  })
}
```

### [dayjsä½¿ç”¨](https://dayjs.fenxianglu.cn/)

```js
import dayjs from "dayjs";

// è·å–MM/DD,å…·ä½“å…¶ä»–ä½¿ç”¨å‚è€ƒå®˜æ–¹æ–‡æ¡£
export function formatMonthDay(date) {
  return dayjs(date).format('MMæœˆDDæ—¥')
}

// è·å–é—´éš”å¤©æ•°
export function getDiffDays(startDate, endDate) {
  return dayjs(endDate).diff(startDate, 'day')
}
```

### æ—¥æœŸæ ¼å¼åŒ–

```js
const date = new Date()
const year = date.getFullYear()
const month = date.getMonth() + 1
const day = date.getDate()
const nowDate: string = year + '.' + (month < 10 ? ('0' + month) : '' + month) + '.' + (day < 10? '0' + day: '' + day)
```

### æ•°å­—é—´éš”ä¸‰ä½åŠ ,

```js
parseFloat(123456 + '').toLocaleString() // 123,456
```

### æ—¶é—´æˆ³ç›¸å…³(Dateæ–¹æ³•, émoment)

```js
Date.parse(new Date()) // éç²¾ç¡®
(new Date()).valueOf() // ç²¾ç¡®
new Date().getTime() // ç²¾ç¡®

// æ—¥æœŸæ—¶é—´è½¬æ—¶é—´æˆ³
Date.parse('2024-01-24 15:30:00') // 1706081400000
// è·å–å½“å‰æ˜ŸæœŸæ•°å€¼ 1234567
(new Date()).getDay()
```

### è‡ªåŠ¨å¾ªç¯æ»šåŠ¨ï¼Œé¼ æ ‡æ‚¬åœæš‚åœï¼Œç§»é™¤ç»§ç»­

é¦–å…ˆæ»šåŠ¨çš„èŠ‚ç‚¹è¦å…ˆç¡®å®šæ˜¯å­˜åœ¨æ»šåŠ¨æ¡ï¼Œä»¥ä¸‹ä»£ç æ‰ç”Ÿæ•ˆ

```js
  useEffect(() => {
    // æ»šåŠ¨ç›¸å…³
    const scrollItem = document.getElementById('auto_scroll')
    let timer: any = null
    if (scrollItem) scrollOperate(scrollItem, timer)
    return () => {
      if (scrollItem) clearOperate(scrollItem, timer)
    }
  }, [])

  // æ»šåŠ¨ç›¸å…³
  const scrollOperate = (scrollItem: HTMLElement, timer: any) => {
    // æ»šåŠ¨
    timer = setInterval(() => { scrollItem.scrollTop += 1 }, 25)
    scrollItem.addEventListener('scroll', scrollHandler)

    // é¼ æ ‡ç§»å…¥ç§»å‡ºç›‘å¬
    scrollItem.addEventListener('mouseenter', () => {
      clearInterval(timer) // æš‚åœæ»šåŠ¨
      scrollItem.removeEventListener('scroll', scrollHandler) // æš‚åœç›‘å¬æ»šåŠ¨
    })
    scrollItem.addEventListener('mouseleave', () => {
      timer = setInterval(() => { scrollItem.scrollTop += 1 }, 25) // ç»§ç»­æ»šåŠ¨
      scrollItem.addEventListener('scroll', scrollHandler) // ç»§ç»­ç›‘å¬æ»šåŠ¨
      // ç‰¹æ®Šæƒ…å†µï¼šé¼ æ ‡ç¦»å¼€æ—¶æ»šåˆ°äº†åº•éƒ¨
      if (scrollItem!.scrollTop + scrollItem!.clientHeight >= scrollItem!.scrollHeight - 0.8) {
        console.log('ç¦»å¼€æ—¶åœ¨åº•éƒ¨')
        scrollItem!.scrollTop = 0 // å½’0é‡æ»š
      }
    })
  }

  // è§¦åº•ç›‘å¬
  const scrollHandler = (e: any) => {
    const scrollItem = document.getElementById('auto_scroll')
    const curScrollHeight = scrollItem!.scrollTop // å½“å‰æ»šåŠ¨äº†çš„é«˜åº¦
    const scrollBarHeight = scrollItem!.clientHeight // æ»šåŠ¨æ¡é«˜åº¦/èŠ‚ç‚¹çª—å£é«˜åº¦
    const totalScrollHeight = scrollItem!.scrollHeight // æ€»é«˜åº¦
    console.log(scrollItem!.scrollTop, scrollItem!.clientHeight, scrollItem!.scrollHeight)
    if (curScrollHeight + scrollBarHeight >= totalScrollHeight - 0.8) { // -1å¢åŠ å®¹é”™
      console.log('æ»šåŠ¨è§¦åº•äº†')
      scrollItem!.scrollTop = 0 // å½’0é‡æ»š
    }
  }

  // ç§»é™¤ç›¸å…³
  const clearOperate = (scrollItem: HTMLElement | null, timer: any) => {
    if(scrollItem) {
      scrollItem.removeEventListener('scroll', scrollHandler)
      clearInterval(timer)
    }
  }
```

### é˜²æŠ–èŠ‚æµtsç‰ˆ

```ts
export function _debounce(
  fn: any,
  delay: number,
  immediate = false,
  resCallback?: any
) {
  let timer: any = null;
  let isInvoke = false;
  function debounce(...args: any) {
    return new Promise((resolve, reject) => {
      // å–æ¶ˆä¸Šä¸€æ¬¡çš„å®šæ—¶å™¨
      if (timer) clearTimeout(timer);
      // æ˜¯å¦ç«‹å³æ‰§è¡Œ
      if (immediate && !isInvoke) {
        const result = fn(args);
        resolve(result); // Promiseæ–¹å¼è¿”å›å€¼
        if (resCallback) resCallback(result); // å›è°ƒè¿”å›å€¼
        isInvoke = true;
      } else {
        timer = setTimeout(() => {
          const result = fn(args);
          resolve(result); // Promiseæ–¹å¼è¿”å›å€¼
          if (resCallback) resCallback(result); // å›è°ƒè¿”å›å€¼
          isInvoke = false;
        }, delay);
      }
    });
  }
  // å–æ¶ˆåŠŸèƒ½(åˆå§‹åŒ–)
  debounce.cancel = function () {
    if (timer) clearTimeout(timer);
    timer = null;
    isInvoke = false;
  };

  return debounce;
}

export function _throttle(
  fn: any,
  interval: number,
  options = { leading: true, trailing: false }
) {
  // é»˜è®¤ç¬¬ä¸€æ¬¡è§¦å‘ï¼Œæœ€åä¸€æ¬¡ä¸è§¦å‘
  let lastTime = 0;
  const { leading, trailing } = options;
  let timer: any = null;

  function throttle(...args: any) {
    // è·å–å½“å‰äº‹ä»¶è§¦å‘çš„æ—¶é—´
    const nowTime = new Date().getTime();
    if (!leading && lastTime === 0) lastTime = nowTime; // å¦‚æœç¬¬ä¸€æ¬¡ä¸è§¦å‘
    // è®¡ç®—è¿˜è¦å¤šé•¿æ—¶é—´è§¦å‘æ‰§è¡Œå‡½æ•°
    const remainTime = interval - (nowTime - lastTime);
    if (remainTime <= 0) {
      if (timer) {
        clearTimeout(timer);
        timer = null;
      }

      fn(args);
      lastTime = nowTime; // é‡ç½®åˆå§‹æ—¶é—´(ä¿ç•™ä¸Šæ¬¡è§¦å‘æ—¶é—´)
      return;
    }

    // æœ€åè§¦å‘
    if (trailing && !timer) {
      timer = setTimeout(() => {
        timer = null;
        lastTime = !leading ? 0 : new Date().getTime();
        fn(args);
        // console.log('123');
      }, remainTime);
    }
  }

  throttle.cancel = function () {
    if (timer) clearTimeout(timer);
    timer = null;
    lastTime = 0;
  };
  return throttle;
}
```

### æ»šåŠ¨è§¦åº•ç›‘å¬(åŠ è½½æ›´å¤š)

```jsx
import { _throttle } from '@/utils/utils';

const Index = () => {
  const scrollListRef = useRef<any>(null);
  
  useEffect(() =>{
    if (scrollListRef.current) {
      scrollListRef.current.addEventListener('scroll', handleScroll)
    }

    return () => {
      scrollListRef.current?.removeEventListener('scroll', handleScroll)
    }
  }, [])
      
  const handleScroll = _throttle(() => {
    // èŠ‚æµç›‘å¬
    if (scrollListRef.current) {
      const { scrollTop, scrollHeight, clientHeight } = scrollListRef.current;
      // console.log(scrollTop, scrollHeight, clientHeight, scrollListRef.current)

      // åˆ¤æ–­æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
      if (scrollTop !== 0 && scrollTop + clientHeight + 15 >= scrollHeight) {
        console.log('å·²ç»æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨15px');
        if (vm.isLastPage) {
          Toast.show({
            content: 'æ²¡æœ‰æ›´å¤šæ•°æ®äº†',
            duration: 1500
          })
          return
        }
        search();
      }
    }
  }, 200, { leading: true, trailing: true });
  
  return <div ref={scrollListRef}></div>
}
```

```ts
const search = async (firstPage: boolean = false) => {
  if (firstPage) { vm.setInfo({ current: 1, list: [] }) }
  console.log(toJS(vm.current), toJS(vm.size), toJS(vm.total), vm.current * vm.size)
  if (vm.total !== 0 && ((vm.current - 1) * vm.size) > vm.total) {
    Toast.show('æ²¡æœ‰æ›´å¤šäº†'); return
  }
  vm.getPageList()
}
  
  // mobx.ts
export class IndexMobx {
  // åˆ—è¡¨æ•°æ®
  list: any[] = [];
  current: number = 1;
  isLastPage: boolean = false;
  size: number = 20;
  total: number = 0;
  constructor() {
    makeAutoObservable(this);
  }
  
  getPageList = async (data: any) => {
    const res = await request({
      url: '',
      method: 'post',
      data: { current: this.current, size: this.size }
    });
    const resData = res.data
    console.log('%c Line:98 ğŸŒ½ åˆ—è¡¨æ•°æ®', 'color:#6ec1c2', resData);
    if (resData?.records?.length) {
      this.setInfo({
        list: [...this.list, ...resData.records],
        current: resData.current < resData.pages ? this.current + 1 : this.current,
        isLastPage: resData.current >= resData.pages,
        total: resData.total
      });
    } else {
      this.setInfo({
        current: this.current,
        total: resData.total
      });
    }
  };
}

export default new IndexMobx();
```

### å¤åˆ¶æ–‡æœ¬åˆ°å‰ªåˆ‡æ¿

```js
export const copyToClipboardFn = (text: string) => {
  var textArea = document.createElement("textarea");
  textArea.value = text;
  // é¿å…æ–‡æœ¬åŸŸåœ¨é¡µé¢ä¸Šå¯è§
  textArea.style.position = "fixed";
  textArea.style.top = "-9999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    var successful = document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    console.log('Text copy command was ' + msg);
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }
  document.body.removeChild(textArea);
  Toast.show({ content: 'å¤åˆ¶æˆåŠŸ' })
  modal.close()
}
```

### é™åˆ¶ç”¨æˆ·ç¼©æ”¾æ§åˆ¶(css)

```css
touch-action: auto;
touch-action: none; // å¯èƒ½ä¼šé™åˆ¶å…¶ä»–æ—¶é—´å¦‚æ»šåŠ¨ã€ç‚¹å‡»ï¼Œéœ€å…·ä½“æµ‹è¯•åä½¿ç”¨
touch-action: pan-y; // é™åˆ¶æ¨ªå‘ç¼©æ”¾ï¼Œä¸é™åˆ¶ç«–å‘æ»šåŠ¨ã€ç‚¹å‡»äº‹ä»¶
```

### æ ¡éªŒæ˜¯å¦æ˜¯JSONå­—ç¬¦ä¸²

```js
export const isJsonString = (str: string) => {
  try {
    const toObj = JSON.parse(str) // jsonå­—ç¬¦ä¸²è½¬å¯¹è±¡
    /*
        åˆ¤æ–­æ¡ä»¶ 1. æ’é™¤nullå¯èƒ½æ€§ 
                 2. ç¡®ä¿æ•°æ®æ˜¯å¯¹è±¡æˆ–æ•°ç»„
    */
    if (toObj && typeof toObj === 'object') { 
      return true
    }
  } catch {}
  return false
}
```

## æ–‡ä»¶ä¸Šä¼ (antd, antd-mobile, Taro.chooseMedia(wx.chooseMedia)æ–¹å¼)

### antd

```jsx
const fn = () => {
const [fileList, setFileList] = useState<any[]>([
    // {
    //   uid: 'rc-upload-1730187304845-7',
    //   name: "é¦–æŠ¥æ¨¡ç‰ˆ.docx",
    //   size: 13800
    // }
  ]);

const uploadFileChange = (file: any) => {
    console.log(file)
    if (file.file.percent === 100 && 'response' in file.file) {
      const res = file.file.response
      const filePath = JSON.parse(Decrypt(res.data))
      // // console.log(res, filePath)
      file.file.filePath = filePath
      onUploadSuccess && onUploadSuccess(file.file)
    }
  }

		return <Upload
            name="file"
            accept='.doc,.docx'
            maxCount={1}
            onRemove={(file) => {
              const index = fileList.indexOf(file);
              const newFileList = fileList.slice();
              newFileList.splice(index, 1);
              setFileList(newFileList);
            }}
            // customRequest={({ file, onSuccess }) => {
            //   const formData = new FormData();
            //   formData.append('file', file);
            //   request({
            //     url: '/escis/api/file/emergency/uploadAttachment',
            //     method: 'post',
            //     for
            //   })
            // }}
            headers={{
              platformtoken: window.localStorage.getItem('webLocal/token')
                ? window.localStorage
                  .getItem('webLocal/token')
                  ?.split('"')[1]
                : '',
              timestamp: new Date().valueOf()
            }}
            action={`${BASE_URL}/escis/api/file/emergency/uploadAttachment`}
            beforeUpload={(file) => {
              console.log(file)
              if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || file.type === 'application/msword') {
                setFileList([file]);
                return true;
              } else {
                Toast.show({
                  content: 'åªèƒ½é€‰æ‹©docæˆ–docxæ–‡ä»¶è¿›è¡Œä¸Šä¼ '
                })
                return false
              }
            }}
            onChange={uploadFileChange}
            fileList={fileList}
          >
            <div className={styles['right_upload']}>
              <img src={require('@/images/upload.png')} alt="" />
            </div>
          </Upload>
}
```

### antd-mobile

```jsx
const fn = () => {
    const problemUploadFn = async (file: any) => {
    // console.log(file, URL.createObjectURL(file))
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', '1');
    const url = await vm.uploadProblemImg(formData);
    console.log(url);
    return {
      url: `${window.location.origin}/file/escis/${url}`
    };
  };

  const problemImgChange = (items: any) => {
    // console.log(items)
    vm.setInfo({ problemImgList: items });
  };

  const problemImgDelete = async (item: any) => {
    const index = item.url.indexOf('/escis');
    const fileName = item.url.slice(index + 7);
    console.log(toJS(item), fileName);
    await vm.deleteProblemImg({ fileName });
  };

  const beforeUpload = (file: any) => {
    if (file.size > 1024 * 1024 * 3) {
      Toast.show('è¯·é€‰æ‹©å°äº 3M çš„å›¾ç‰‡');
      return null;
    }
    return file;
  };
  
  return <ImageUploader deletable={!disabled} disableUpload={disabled}  {...{
                maxCount: 3,
                value: vm.problemImgList,
                upload: problemUploadFn,
                onChange: problemImgChange,
                onDelete: problemImgDelete,
                beforeUpload: beforeUpload
              }} />
}
```

### Taro(wx).chooseMedia

```jsx
const fn = () => {
    const uploadClick = () => {
    Taro.chooseMedia({
      count: 1,
      mediaType: ['image'],
      sourceType: ['album', 'camera'],
      camera: 'back',
      success: (res) => {
        Taro.showLoading({ title: 'æ–‡ä»¶ä¸Šä¼ ä¸­...' })
        Taro.uploadFile({
          url: BASE_URL + `/blade-resource/oss/endpoint/put-file`, //ä»…ä¸ºç¤ºä¾‹ï¼ŒéçœŸå®çš„æ¥å£åœ°å€
          // url: apiConfig.baseUrl + `/blade-resource/oss/endpoint/put-file`, //ä»…ä¸ºç¤ºä¾‹ï¼ŒéçœŸå®çš„æ¥å£åœ°å€
          filePath: res.tempFiles[0].tempFilePath,
          name: 'file',
          header: {
            'Blade-Auth': Taro.getStorageSync('access_token')
          },
          formData: {},
          success(rea) {
            Taro.hideLoading()
            // console.log(rea, JSON.parse(Decrypt(rea.data)), 595959)
            const data = JSON.parse(Decrypt(rea.data))
            console.log("%c Line:65 ğŸ¥Ÿ rea", "color:#7f2b82", rea, data);
            if (data.code === 200 && data.success) {
              const newUploadUrlList = [...uploadUrlList]
              newUploadUrlList.push(data.data.link)
              // setUploadUrlList(newUploadUrlList)
              uploadUrlListChange && uploadUrlListChange(newUploadUrlList)
            } else {
              Taro.showToast({ title: `æ–‡ä»¶ä¸Šä¼ å¤±è´¥ ${data.msg}`, icon: 'none' })
            }
          },
          fail: (err) => {
            Taro.hideLoading()
            Taro.showToast({ title: `æ–‡ä»¶ä¸Šä¼ å¤±è´¥ ${err}`, icon: 'none' })
          }
        })
      },
      fail: (err) => {
        // Taro.showToast({ title: `æ–‡ä»¶é€‰æ‹©å¤±è´¥ ${err}`, icon: 'none' })
      }
    })
  }
}
```



### exceljsç»“åˆåç«¯æ¨¡æ¿ï¼Œå¡«å…¥å‰ç«¯æ•°æ®

æ³¨æ„åŒºåˆ†ä¸€ä¸ªexcelæ–‡ä»¶å’Œä¸€ä¸ªexcelä¸­çš„å¤šä¸ªå·¥ä½œè¡¨

https://blog.csdn.net/baidu_41927649/article/details/135544463

![pkeCJ3Q.png](https://s21.ax1x.com/2024/05/11/pkeCJ3Q.png)

```js
import request from '@/service/request';
import ExcelJS from 'exceljs';
import dayjs from 'dayjs';

const downTemplateTable = async () => {
  const backValue: any = await request({
    url: '/beris/api/static/patterns/æ•™è¾…ææ–™.xlsx',
    method: 'GET',
    responseType: 'blob'
  });

  return backValue as Blob;
};

const returnArrayBuffer = (blob: Blob) => {
  const reader = new FileReader();

  return new Promise(
    (res: (value: ArrayBuffer) => void, rej) => {
      reader.readAsArrayBuffer(blob);
      reader.onload = (e: any) => {
        res(e.target.result);
      };
    }
  );
};

// ä½¿ç”¨arrayBuffer
const initWorkbook = async (arrayBuffer: ArrayBuffer) => {
  // åˆ›å»ºä¸€ä¸ªexcel
  const workbook = new ExcelJS.Workbook();

  return new Promise(
    async (
      res: (value: {
        sheet: ExcelJS.Worksheet;
        workbook: ExcelJS.Workbook;
      }) => void,
      rej
    ) => {
      // excelä¸­åŠ å…¥æ¨¡æ¿æ•°æ®
      const bolbLoad = await workbook.xlsx.load(
        arrayBuffer
      );

      // åˆ›å»ºä¸”è¿”å›excelä¸­çš„ä¸€ä¸ªå·¥ä½œè¡¨
      const sheet = await bolbLoad.getWorksheet('æƒ…å†µè¡¨22');

      res({
        sheet: sheet as ExcelJS.Worksheet,
        workbook: workbook
      });
    }
  );
};

// ä»…ä¾›å‚è€ƒï¼Œéƒ¨åˆ†æ–¹æ³•è§£é‡Š
const addRowToExcel = (
  sheet: ExcelJS.Worksheet,
  data: any,
  semester: string
) => {
  const titleString =
    'å…¨çœä¸­å°å­¦(å¹¼å„¿å›­)å’Œä¸­èŒå­¦æ ¡XXXXXXç»Ÿè®¡è¡¨';

  const sheetTitleRow = sheet.getRow(1);
  sheetTitleRow.values = [`${titleString}  ${semester}`];
  sheet.mergeCells(
    `A${sheetTitleRow.number}:U${sheetTitleRow.number}`
  );

  sheetTitleRow.height = 39.15;
  sheetTitleRow.font = {
    name: 'é»‘ä½“',
    size: 12,
    bold: true
  };

  sheetTitleRow.alignment = {
    vertical: 'middle',
    horizontal: 'center',
    wrapText: false
  };

  const lastString = `æ³¨ï¼š
  1.XXXXXXXXXXXXXXXXXXç­‰ã€‚
  2.XXXXXXXXXXXXXXXXXXâ€œæ— â€ã€‚     
  3.XXXXXXXXXXXXXXXXXXã€‚ 
  4.XXXXXXXXXXXXXXXXXX`;

  const typeOne = `ä¸€ã€â€œXXXXXXXXXXXXXXXXXXï¼‰`;
  const typeTwo = `äºŒã€XXXXXXXXXXXXXXXXXX`;
  const typeThree = `ä¸‰ã€XXXXXXXXXXXXXXXXXX`;

  const { jfcl, qt, xsdw } = data;

  if (jfcl.length > 0) {
    const titleRow = sheet.addRow([typeOne]);
    sheet.mergeCells(
      `A${titleRow.number}:U${titleRow.number}`
    );
    titleRow.font = {
      name: 'åæ–‡ä»¿å®‹',
      size: 8,
      bold: true
    };
    titleRow.alignment = {
      vertical: 'middle',
      horizontal: 'center',
      wrapText: true
    };
    jfcl.forEach((item: any, index: number) => {
      const row = sheet.addRow(item);
      item.forEach((oo: string, i: number) => {
        row.getCell(i + 1).border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
      });
      row.height = 30.8;
      row.font = {
        name: 'å®‹ä½“',
        size: 8
      };
      row.alignment = {
        vertical: 'middle',
        horizontal: 'left',
        wrapText: true
      };
    });
  }

  if (qt.length > 0) {
    const titleRow = sheet.addRow([typeTwo]);
    sheet.mergeCells(
      `A${titleRow.number}:U${titleRow.number}`
    );
    titleRow.font = {
      name: 'åæ–‡ä»¿å®‹',
      size: 8,
      bold: true
    };
    titleRow.alignment = {
      vertical: 'middle',
      horizontal: 'center',
      wrapText: true
    };
    qt.forEach((item: any, index: number) => {
      const row = sheet.addRow(item);
      item.forEach((oo: string, i: number) => {
        row.getCell(i + 1).border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
      });
      row.height = 30.8;
      row.font = {
        name: 'å®‹ä½“',
        size: 8
      };
      row.alignment = {
        vertical: 'middle',
        horizontal: 'left',
        wrapText: true
      };
    });
  }

  if (xsdw.length > 0) {
    const titleRow = sheet.addRow([typeThree]);
    sheet.mergeCells(
      `A${titleRow.number}:U${titleRow.number}`
    );
    titleRow.font = {
      name: 'åæ–‡ä»¿å®‹',
      size: 8,
      bold: true
    };
    titleRow.alignment = {
      vertical: 'middle',
      horizontal: 'center',
      wrapText: true
    };
    xsdw.forEach((item: any, index: number) => {
      const row = sheet.addRow(item);
      item.forEach((oo: string, i: number) => {
        row.getCell(i + 1).border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
      });
      row.height = 30.8;
      row.font = {
        name: 'å®‹ä½“',
        size: 8
      };
      row.alignment = {
        vertical: 'middle',
        horizontal: 'left',
        wrapText: true
      };
    });
  }

  // @ts-ignore
  Array.apply(null, { length: 2 }).forEach(() => {
    sheet.addRow([]);
  });

  const lastRow = sheet.addRow([lastString]);
  lastRow.height = 66.65;
  sheet.mergeCells(`A${lastRow.number}:S${lastRow.number}`);
  lastRow.font = {
    name: 'é»‘ä½“',
    size: 8
  };
  lastRow.alignment = {
    vertical: 'top',
    horizontal: 'left',
    wrapText: true
  };
};

// å¤–éƒ¨æ–‡ä»¶è°ƒå–DownExcel
const DownExcel = async (data: any, semester: string) => {
  // 1.è·å–excelæ¨¡æ¿ blobäºŒè¿›åˆ¶æ–‡ä»¶æµ
  const blob = await downTemplateTable();
  // 2.blobè½¬ArrayBuffer
  const arrayBuffer = await returnArrayBuffer(blob);
  // 3.exceljsåˆå§‹åŒ–ï¼Œè·å–workbook excelæ–‡ä»¶å’Œå†…éƒ¨å·¥ä½œè¡¨sheet
  const { sheet, workbook } = await initWorkbook(
    arrayBuffer
  );
  // 4.æ ¹æ®æ‹¿åˆ°çš„å·¥ä½œè¡¨sheetï¼Œå°†æ•°æ®å‰ç«¯jsæ•°æ®å¡«å…¥è¡¨æ ¼ä¸­
  // è¯¦ç»†çš„æ’å…¥æ•°æ®æ–¹æ³•å‚ç…§exceljsç›¸å…³æ–‡æ¡£
  addRowToExcel(sheet, data, semester);

  // 5.workbook excelè¡¨æ ¼è½¬ä¸ºbufferæ–‡ä»¶æµ
  const file = await workbook.xlsx.writeBuffer();

  // 6.æ–‡ä»¶æµå¸¸è§„ä¸‹è½½
  const newBlob = new Blob([file], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = window.URL.createObjectURL(newBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `æ•™è¾…ææ–™é¡¹ç›®æƒ…å†µç»Ÿè®¡è¡¨${dayjs().format(
    'YYYYMMDDHHmmss'
  )}.xlsx`;
  document.body.appendChild(a);
  a.click();
  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);
};

export default DownExcel;
```

## react MediaRecorderå®ç°å½•éŸ³åŠŸèƒ½

```ts
import { observable, makeObservable, action, toJS, makeAutoObservable } from 'mobx';
import request from '@/utils/request';

export class IndexMobx {
  // 0æœªå¼€å§‹ 1å½•éŸ³ä¸­ 2å·²æš‚åœ 3å½•éŸ³ç»“æŸ
  recordState: number = 0;
  // è®¡æ—¶æ˜¾ç¤º
  recordTimeText: string = '00:00:00';

  constructor() {
    makeAutoObservable(this);
  }

  setInfo = (info: Record<string, any>) => {
    Object.keys(info).forEach(key => {
      this[key as keyof typeof this] = info[key];
    });
  };

  clean = () => {
    this.setInfo({
      recordState: 0
    });
  };
}

export default new IndexMobx();

```

```jsx
import React, { FC, useEffect, useRef, useState } from 'react'
import styles from './index.module.less'
import { observer, useLocalObservable } from 'mobx-react'
import IndexMobx from './mobx/index'
import dayjs from 'dayjs'
import { useNavigate } from 'react-router-dom'

type IndexProps = {

}

const Index: FC<IndexProps> = (props) => {
  const vm = useLocalObservable(() => IndexMobx)

  const radiusClick = () => {
    if (vm.recordState == 3) return
    if (vm.recordState == 0) {
      // å¼€å§‹
      startRecording()
    } else if (vm.recordState == 1 || vm.recordState == 2) {
      // æš‚åœæˆ–ç»§ç»­
      togglePause()
    }
  }

  const overRecord = () => {
    if (vm.recordState == 0 || vm.recordState == 3) return
    stopRecording()
  }


  // å½•éŸ³åŠŸèƒ½æ¨¡å—ä»£ç 
  const [audioUrl, setAudioUrl] = useState('');
  const [duration, setDuration] = useState(0);

  const mediaRecorder = useRef<any>(null);
  const audioChunks = useRef<any>([]);
  const timerRef = useRef<any>(null);
  const startTime = useRef<any>(0);

  // åˆå§‹åŒ–å½•éŸ³
  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder.current = new MediaRecorder(stream);

      mediaRecorder.current.ondataavailable = (e: any) => {
        audioChunks.current.push(e.data);
      };

      mediaRecorder.current.onstop = () => {
        const audioBlob = new Blob(audioChunks.current, { type: 'audio/webm' });
        const url = URL.createObjectURL(audioBlob);
        setAudioUrl(url);
        audioChunks.current = [];
      };

      mediaRecorder.current.start();
      vm.setInfo({ recordState: 1 })
      startTimer();
    } catch (err) {
      console.error('æ— æ³•è·å–éº¦å…‹é£æƒé™:', err);
    }
  };

  // æš‚åœ/æ¢å¤å½•éŸ³
  const togglePause = () => {
    if (vm.recordState == 2) {
      mediaRecorder.current.resume();
      startTimer();
    } else {
      mediaRecorder.current.pause();
      clearInterval(timerRef.current);
    }
    vm.setInfo({ recordState: vm.recordState == 1 ? 2 : 1 })
  };

  // åœæ­¢å½•éŸ³
  const stopRecording = () => {
    mediaRecorder.current.stop();
    vm.setInfo({ recordState: 3 })
    clearInterval(timerRef.current);
  };

  // è®¡æ—¶å™¨é€»è¾‘
  const startTimer = () => {
    startTime.current = Date.now() - (duration * 1000);
    clearInterval(timerRef.current);
    timerRef.current = setInterval(() => {
      setDuration(Math.floor((Date.now() - startTime.current) / 1000));
    }, 1000);
  };

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  const formatTime = (seconds: any) => {
    console.log("%c Line:102 ğŸ¥ seconds", "color:#b03734", seconds);
    const hour = Math.floor(seconds / 60 / 60).toString().padStart(2, '0');
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${hour}:${mins}:${secs}`;
  };

  return (
    <div className={styles['sound_record']}>
      <div className={styles['record_radius']}>
        <div className={`${styles['center_radius']} ${vm.recordState == 1 ? styles['center_radius_active'] : ''}`} onClick={radiusClick}>
          <div className={styles['icon']}>
            <img src={require(`@/images/recordSound/${vm.recordState == 0 || vm.recordState == 2 ? 'voice' : vm.recordState == 1 ? 'record_pause' : vm.recordState == 3 ? 'record_over' : ''}.png`)} alt="" />
          </div>
          <div className={styles['state_text']}>{vm.recordState == 0 ? 'å¼€å§‹å½•éŸ³' : vm.recordState == 1 ? 'å½•éŸ³ä¸­' : vm.recordState == 2 ? 'ç»§ç»­å½•éŸ³' : vm.recordState == 3 ? 'å®Œæˆå½•éŸ³' : ''}</div>
        </div>
      </div>
      <div className={styles['time']}>
        <div className={styles['start_time']}>{formatTime(duration)}</div>
        <div className={styles['center']}>/</div>
        <div className={styles['end_time']}>06:00:00</div>
      </div>
      {/* æ’­æ”¾å½•éŸ³ */}
      {audioUrl && (
        <div>
          <audio controls src={audioUrl} />
          <a href={audioUrl} download="recording.wav">ä¸‹è½½å½•éŸ³</a>
        </div>
      )}
    </div>
  )
}

export default observer(Index)
```

## js-audio-recorderåœ¨reactä¸­å®ç°å½•éŸ³åŠŸèƒ½

/mobx/index.ts

```ts
/*
 * @Author: OctopusRoe
 * @Date: 2024-05-28 17:22:57
 * @LastEditors: OctopusRoe
 * @LastEditTime: 2024-05-29 16:09:38
 * @Description:
 */

import { observable, makeObservable, action, toJS, makeAutoObservable } from 'mobx';
import request from '@/utils/request';

export class IndexMobx {
  // 0æœªå¼€å§‹ 1å½•éŸ³ä¸­ 2å·²æš‚åœ 3å½•éŸ³ç»“æŸ
  recordState: number = 0;
  // å½•éŸ³æ–‡ä»¶æµ (éœ€è½¬å†™çš„æ–‡ä»¶æµ)
  audioUrl: any = '';
  // æ–‡ä»¶æµè½¬å†™çŠ¶æ€ 0æœªè½¬å†™ 1è½¬å†™ä¸­ 2è½¬å†™æˆåŠŸ 3è½¬å†™å¤±è´¥
  exChangeState: number = 0;

  constructor() {
    makeAutoObservable(this);
  }

  setInfo = (info: Record<string, any>) => {
    Object.keys(info).forEach(key => {
      this[key as keyof typeof this] = info[key];
    });
  };

  // ä¸Šä¼ å½•éŸ³æ–‡ä»¶
  uploadRecordingFile = async () => {
    const formData = new FormData();
    formData.append('dir', 'hyjy');
    formData.append('file', this.audioUrl);
    formData.append('meetingName', '' as any);
    formData.append('meetingDateTime', '' as any);
    formData.append('meetingAddr', '' as any);
    formData.append('fileType', '3'); // 1å¯¼å…¥éŸ³é¢‘ 2å¯¼å…¥æ–‡æœ¬ 3å®æ—¶å½•åˆ¶
    const res: any = await request({
      url: '/aichat/api/v1/meetingRecord/upload',
      method: 'post',
      // headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      data: formData
    });
    console.log('%c Line:39 ğŸ‰ è½¬å†™res', 'color:#93c0a4', res);
  };

  // å½•éŸ³è½¬å†™
  exChangeAudio = async (data: any) => {
    const formData = new FormData();
    formData.append('file', this.audioUrl);
    const res: any = await request({
      url: '/aichat/api/v1/meetingRecord/exChangeAsr',
      method: 'post',
      data: data
    });
    console.log('%c Line:39 ğŸ‰ è½¬å†™res', 'color:#93c0a4', res);
  };

  clean = () => {
    this.setInfo({
      recordState: 0,
      audioUrl: '',
      exChangeState: 0
    });
  };
}

export default new IndexMobx();
```

**indexView.tsx**

```jsx
import React, { FC, useEffect, useRef, useState } from 'react'
import styles from './index.module.less'
import { observer, useLocalObservable } from 'mobx-react'
import IndexMobx from './mobx/index'
import dayjs from 'dayjs'
import { useNavigate } from 'react-router-dom'
import { message, Modal } from 'antd'
import { toJS } from 'mobx'
import { Dialog, Toast } from 'antd-mobile'
import { getCurrentDate } from '@/utils/utilFuncs'
import JsAudioRecorder from 'js-audio-recorder';

type IndexProps = {

}

const Index: FC<IndexProps> = (props) => {
  const vm = useLocalObservable(() => IndexMobx)
  const navigate = useNavigate()

  const backClick = () => {
    if (vm.recordState == 0) {
      navigate(-1)
    } else if (vm.recordState == 1) {
      Toast.show({ content: 'æ­£åœ¨å½•éŸ³ä¸­ï¼Œæ— æ³•è¿”å›' })
    } else if (vm.recordState == 2) {
      Toast.show({ content: 'å½•éŸ³æœªç»“æŸï¼Œæ— æ³•è¿”å›' })
    } else if (vm.recordState == 3) {
      Dialog.show({
        content: 'æ‚¨å½•åˆ¶çš„ä¼šè®®è¿˜æœªè¿›è¡Œè½¬å†™ï¼Œä¸æ”¯æŒä¿å­˜åˆ°æœ¬åœ°ï¼Œç¡®è®¤éœ€è¦é€€å‡ºæ­¤ä¼šè®®ä¿¡æ¯å—ï¼Ÿ',
        closeOnAction: true,
        actions: [[
          {
            key: 'cancel',
            text: 'å–æ¶ˆ',
          },
          {
            key: 'delete',
            text: 'ç¡®è®¤',
            bold: true,
            onClick: () => {
              navigate(-1)
            }
          },
        ]],
      })
    }
  }

  const radiusClick = () => {
    if (vm.recordState == 3) return
    if (vm.recordState == 0) {
      // å¼€å§‹
      startRecording()
    } else if (vm.recordState == 1 || vm.recordState == 2) {
      // æš‚åœæˆ–ç»§ç»­
      if (vm.recordState == 1) {
        pauseRecording()
      }
      if (vm.recordState == 2) {
        resumeRecording()
      }
    }
  }

  const overRecord = async () => {
    console.log(toJS(vm.recordState))
    if (vm.recordState == 0 || vm.recordState == 3) return
    const result = await Dialog.confirm({
      content: 'ç¡®å®šè¦ç»“æŸè¯¥æ®µå½•éŸ³å—ï¼Ÿ',
    })
    if (result) {
      // Toast.show({ content: 'ç‚¹å‡»äº†ç¡®è®¤' })
      stopRecording()
    }
  }

  // å½•éŸ³åŠŸèƒ½æ¨¡å—ä»£ç 
  const [duration, setDuration] = useState(0);
  const recorderRef = useRef<any>(null);

  // åˆå§‹åŒ–å½•éŸ³å®ä¾‹
  useEffect(() => {
    // å®ä¾‹åŒ–
    recorderRef.current = new JsAudioRecorder({
      sampleBits: 16,      // é‡‡æ ·ä½æ•°
      sampleRate: 8000,   // é‡‡æ ·ç‡
      numChannels: 1,      // å£°é“æ•°
    });
    // è®¾ç½®å½•éŸ³æ—¶é•¿æ›´æ–°å›è°ƒ
    recorderRef.current.onprogress = (params: any) => {
      setDuration(Math.floor(params.duration));
    };

    return () => {
      // ç»„ä»¶å¸è½½æ—¶é”€æ¯å½•éŸ³å®ä¾‹
      recorderRef.current.destroy();
      resetRecordState()
    };
  }, []);

  useEffect(() => {
    if (vm.audioUrl) {
      uploadRecordAudio()
    }
  }, [vm.audioUrl]);
  useEffect(() => {
    if (duration >= 6 * 60 * 60 - 1) {
      Toast.show({ content: 'å·²è¾¾åˆ°æœ€é•¿å½•éŸ³æ—¶é•¿6å°æ—¶ï¼Œè‡ªåŠ¨ç»“æŸå½•éŸ³' })
      stopRecording()
    }
  }, [duration]);

  // å¼€å§‹å½•éŸ³
  const startRecording = async () => {
    try {
      await recorderRef.current.start();
      vm.setInfo({ recordState: 1 })
    } catch (error) {
      console.error('å½•éŸ³å¼€å§‹å¤±è´¥:', error);
      alert('è¯·å…è®¸éº¦å…‹é£æƒé™åé‡è¯•');
    }
  };

  // æš‚åœå½•éŸ³
  const pauseRecording = () => {
    recorderRef.current.pause();
    vm.setInfo({ recordState: 2 })
  };

  // ç»§ç»­å½•éŸ³
  const resumeRecording = () => {
    recorderRef.current.resume();
    vm.setInfo({ recordState: 1 })
  };

  // åœæ­¢å½•éŸ³
  const stopRecording = () => {
    recorderRef.current.stop();
    vm.setInfo({ recordState: 3 })
    // uploadRecordAudio()
    // è·å–WAVæ ¼å¼çš„Blobæ•°æ®
    const blob = recorderRef.current.getWAVBlob();
    // åˆ›å»ºFormData
    const audioFile = new File([blob], getCurrentDate() + '.wav');
    console.log("%c Line:142 ğŸª audioFile", "color:#ffdd4d", blob, audioFile);
    vm.setInfo({ audioUrl: audioFile })
  };

  // ä¸Šä¼ å½•éŸ³
  const uploadRecordAudio = async () => {
    await vm.uploadRecordingFile()
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  const formatTime = (seconds: any) => {
    console.log("%c Line:102 ğŸ¥ seconds", "color:#b03734", seconds);
    const hour = Math.floor(seconds / 60 / 60).toString().padStart(2, '0');
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${hour}:${mins}:${secs}`;
  };

  // å–æ¶ˆå½•éŸ³
  const cancelRecordClick = () => {
    console.log(toJS(vm.recordState), toJS(vm.exChangeState))
    if (vm.recordState == 0) return
    if (vm.recordState == 3 && vm.exChangeState == 2) return
    if ([1, 2].includes(vm.recordState)) {
      Toast.show({ content: 'å½•éŸ³æ“ä½œè¿˜æœªç»“æŸï¼Œæ— æ³•å–æ¶ˆ' });
      return
    } else if (vm.recordState == 3) {
      if (vm.audioUrl) {
        if (vm.exChangeState == 1) {
          Toast.show({ content: 'å½•éŸ³è½¬å†™ä¸­ï¼Œæ— æ³•å–æ¶ˆ' });
          return
        } else if (vm.exChangeState == 0 || vm.exChangeState == 2 || vm.exChangeState == 3) {
          Dialog.show({
            content: vm.exChangeState == 0 ? 'æ‚¨å½•åˆ¶çš„ä¼šè®®è¿˜æœªè¿›è¡Œè½¬å†™ï¼Œä¸æ”¯æŒä¿å­˜åˆ°æœ¬åœ°ï¼Œç¡®è®¤éœ€è¦åˆ é™¤æ­¤ä¼šè®®ä¿¡æ¯å—ï¼Ÿ'
              : `æ‚¨å½•åˆ¶çš„ä¼šè®®è½¬å†™${vm.exChangeState == 2 ? 'æˆåŠŸ' : 'å¤±è´¥'}ï¼Œç¡®è®¤é‡ç½®çŠ¶æ€å¼€å§‹æ–°çš„å½•åˆ¶å—ï¼Ÿ`,
            closeOnAction: true,
            actions: [[
              {
                key: 'cancel',
                text: 'å–æ¶ˆ',
              },
              {
                key: 'delete',
                text: 'ç¡®è®¤',
                bold: true,
                onClick: resetRecordState
              },
            ]],
          })
        }
      }
    }
  }
  // é‡ç½®å½•éŸ³çŠ¶æ€
  const resetRecordState = () => {
    setDuration(0);
    vm.clean()
  }

  return (
    <>
      <div className={styles['sound_record']}>
        <div className={styles['record_radius']}>
          <div className={`${styles['center_radius']} ${vm.recordState == 1 ? styles['center_radius_active'] : ''}`} onClick={radiusClick}>
            <div className={styles['icon']}>
              <img src={require(`@/assets/images/liyili/recordSound/${vm.recordState == 0 || vm.recordState == 2 ? 'voice' : vm.recordState == 1 ? 'record_pause' : vm.recordState == 3 ? 'record_over' : ''}.png`)} alt="" />
            </div>
            <div className={styles['state_text']}>{vm.recordState == 0 ? 'å¼€å§‹å½•éŸ³' : vm.recordState == 1 ? 'å½•éŸ³ä¸­' : vm.recordState == 2 ? 'ç»§ç»­å½•éŸ³' : vm.recordState == 3 ? 'å®Œæˆå½•éŸ³' : ''}</div>
          </div>
        </div>
        <div className={styles['time']}>
          <div className={styles['start_time']}>{formatTime(duration)}</div>
          <div className={styles['center']}>/</div>
          <div className={styles['end_time']}>06:00:00</div>
        </div>
        <div className={styles['bottom_three']}>
          <div className={`${styles['left']} ${[1, 2, 3].includes(vm.recordState) ? styles['left_active'] : ''}`} onClick={cancelRecordClick}>å–æ¶ˆ</div>
          <div className={styles['center']} onClick={overRecord}>
            <img src={require(`@/assets/images/liyili/recordSound/${vm.recordState == 0 || vm.recordState == 3 ? 'record_disable' : 'record_available'}.png`)} alt="" />
          </div>
          <div className={`${styles['right']} ${vm.recordState == 3 ? styles['right_avtice'] : ''}`} onClick={exChangeRecording}>å¼€å§‹è½¬å†™</div>
        </div>
      </div>
    </>
  )
}

export default observer(Index)
```

